<h2>All songs</h2>
<ul>
	<% songs.forEach(song => { %>
	<li>
		<h3>Title: <%= song.title %></h3>
		<p>Artist: <%= song.artist %></p>
		<p>Album: <%= song.album %></p>
		<p>Duration: <%= song.duration %> minutes</p>
		<audio controls name="<%= song.title %>">
			<source src="./<%= song.filePath %>" type="audio/mpeg" />
			Your browser does not support the audio tag.
		</audio>
		<a href="./music/<%= song.filename %>" download="<%= song.filename %>"
			>Завантажити пісню</a
		>
	</li>
	<% }); %>
</ul>
<script>
	function addListened(username, songName) {
		console.log('ADD LISTENED CLIENT:', username, songName)
		const data = {
			username: username,
			songName: songName
		}
		fetch('/addListened', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		})
			.then(response => {
				console.log(response)
				if (!response.ok) {
					throw new Error('Failed to add song to history')
				}
				return response.json()
			})
			.then(data => {
				console.log(data)
			})
			.catch(error => {
				console.error('Error adding song to history: ', error)
			})
	}
	document.addEventListener('DOMContentLoaded', () => {
		let audios = document.querySelectorAll('audio')

		audios.forEach(audio => {
			audio.addEventListener('play', event => {
				const songName = event.target.getAttribute('name')
				console.log(songName)

				const username = '<%= username %>'
				console.log(username, ' ', songName)
				addListened(username, songName)
			})
		})
	})
</script>
